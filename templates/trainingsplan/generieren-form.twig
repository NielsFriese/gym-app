{# templates/trainingsplan/generieren-form.twig #}
{% extends 'layout.twig' %}

{% block content %}
<div class="container mt-4">
    <h1>{{ title }}</h1>
    
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Trainingsplan für {{ mitglied.vorname }} {{ mitglied.nachname }} erstellen</h5>
        </div>
        <div class="card-body">
            <form method="post" action="{{ submitUrl }}">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="plan_name">Name des Trainingsplans</label>
                            <input type="text" class="form-control" id="plan_name" name="plan_name" value="Trainingsplan für {{ mitglied.vorname }}" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="schwierigkeitsgrad">Schwierigkeitsgrad</label>
                            <select class="form-control" id="schwierigkeitsgrad" name="schwierigkeitsgrad">
                                <option value="Anfänger">Anfänger</option>
                                <option value="Fortgeschritten">Fortgeschritten</option>
                                <option value="Experte">Experte</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="trainingsart">Trainingsart</label>
                            <select class="form-control" id="trainingsart" name="trainingsart">
                                <option value="Kraftausdauer">Kraftausdauer (3-4 Sätze, 15-22 Wiederholungen)</option>
                                <option value="Muskelaufbau">Muskelaufbau (2-3 Sätze, 6-10 Wiederholungen)</option>
                                <option value="IK Training">IK Training (1-2 Sätze, 1-4 Wiederholungen)</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="split_typ">Split-Typ</label>
                            <select class="form-control" id="split_typ" name="split_typ">
                                <option value="Ganzkörper">Ganzkörper (7 Übungen)</option>
                                <option value="Zweier-Split">Zweier-Split: Oberkörper/Beine (je max. 7 Übungen)</option>
                                <option value="Dreier-Split">Dreier-Split: Beine, Brust/Trizeps, Rücken/Bizeps (je max. 7 Übungen)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="trainingsdauer">Trainingsdauer</label>
                            <select class="form-control" id="trainingsdauer" name="trainingsdauer">
                                <option value="30">30 Minuten</option>
                                <option value="45">45 Minuten</option>
                                <option value="60" selected>60 Minuten</option>
                                <option value="90">90 Minuten</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="trainingsumgebung">Trainingsumgebung</label>
                            <select class="form-control" id="trainingsumgebung" name="trainingsumgebung">
                                <option value="Fitnessstudio">Fitnessstudio</option>
                                <option value="Heimtraining">Heimtraining</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="trainingsfrequenz">Trainingshäufigkeit pro Woche</label>
                            <select class="form-control" id="trainingsfrequenz" name="trainingsfrequenz">
                                <option value="2">2x pro Woche</option>
                                <option value="3" selected>3x pro Woche</option>
                                <option value="4">4x pro Woche</option>
                                <option value="5">5x pro Woche</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="spezifisches_ziel">Spezifisches Ziel</label>
                            <select class="form-control" id="spezifisches_ziel" name="spezifisches_ziel">
                                <option value="">Kein spezifisches Ziel</option>
                                <option value="Definitionsphase">Definitionsphase</option>
                                <option value="Maximalkraft">Maximalkraft</option>
                                <option value="Athletik">Athletik</option>
                                <option value="Rehabilitation">Rehabilitation</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="erholungszeit">Erholungszeiten</label>
                            <select class="form-control" id="erholungszeit" name="erholungszeit">
                                <option value="Kurz">Kurz (30-60 Sekunden)</option>
                                <option value="Mittel" selected>Mittel (90-120 Sekunden)</option>
                                <option value="Lang">Lang (2-5 Minuten)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label for="koerperliche_einschraenkungen">Körperliche Einschränkungen</label>
                            <textarea class="form-control" id="koerperliche_einschraenkungen" name="koerperliche_einschraenkungen" rows="2" placeholder="Gelenk-, Rücken- oder andere Probleme"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="periodisierung" name="periodisierung" value="1">
                            <label class="form-check-label" for="periodisierung">
                                Periodisierung (wöchentliche/monatliche Belastungszyklen)
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="spezielle_techniken" name="spezielle_techniken" value="1">
                            <label class="form-check-label" for="spezielle_techniken">
                                Spezielle Techniken (Supersätze/Dropsets)
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="aufwaermphase" name="aufwaermphase" value="1" checked>
                            <label class="form-check-label" for="aufwaermphase">
                                Aufwärmphase (passende Mobilisationsübungen)
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="progression" name="progression" value="1" checked>
                            <label class="form-check-label" for="progression">
                                Progressionsmodell (automatische Anpassung der Schwierigkeit)
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="kardio_integration" name="kardio_integration" value="1">
                            <label class="form-check-label" for="kardio_integration">
                                Kardio-Integration (als Ergänzung zum Krafttraining)
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="use_maximalkraft" name="use_maximalkraft" value="1">
                            <label class="form-check-label" for="use_maximalkraft">
                                Maximalkraft-Tests für Gewichtsberechnung verwenden
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label for="ernaehrungshinweise">Ernährungshinweise</label>
                            <textarea class="form-control" id="ernaehrungshinweise" name="ernaehrungshinweise" rows="2" placeholder="Grundlegende Ernährungstipps passend zum Trainingsziel"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="form-group mb-3">
                    <label for="notizen">Notizen</label>
                    <textarea class="form-control" id="notizen" name="notizen" rows="3"></textarea>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="manuelle_gewichte" name="manuelle_gewichte" value="1" onchange="toggleGewichtFelder(this.checked)">
                    <label class="form-check-label" for="manuelle_gewichte">
                        Gewichte manuell einstellen
                    </label>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Trainingstage</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="trainingstage[]" value="Montag" id="tag_montag" checked>
                                    <label class="form-check-label" for="tag_montag">Montag</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="trainingstage[]" value="Dienstag" id="tag_dienstag">
                                    <label class="form-check-label" for="tag_dienstag">Dienstag</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="trainingstage[]" value="Mittwoch" id="tag_mittwoch" checked>
                                    <label class="form-check-label" for="tag_mittwoch">Mittwoch</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="trainingstage[]" value="Donnerstag" id="tag_donnerstag">
                                    <label class="form-check-label" for="tag_donnerstag">Donnerstag</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="trainingstage[]" value="Freitag" id="tag_freitag" checked>
                                    <label class="form-check-label" for="tag_freitag">Freitag</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="trainingstage[]" value="Samstag" id="tag_samstag">
                                    <label class="form-check-label" for="tag_samstag">Samstag</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="trainingstage[]" value="Sonntag" id="tag_sonntag">
                                    <label class="form-check-label" for="tag_sonntag">Sonntag</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h4 class="mt-4">Übungen auswählen (optional)</h4>
                <p class="text-muted">Sie können optional Übungen für den Trainingsplan auswählen. Wenn Sie keine Übungen auswählen, werden automatisch passende Übungen basierend auf Schwierigkeitsgrad und Trainingsart ausgewählt. Es werden immer mindestens 7 Übungen im Trainingsplan enthalten sein.</p>
                
                <div class="accordion" id="uebungenAccordion">
                    {% for muskelgruppe, muskelgruppeUebungen in uebungenNachMuskelgruppe %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading{{ loop.index }}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="false" aria-controls="collapse{{ loop.index }}">
                                {{ muskelgruppe }} ({{ muskelgruppeUebungen|length }} Übungen)
                            </button>
                        </h2>
                        <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#uebungenAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    {% for uebung in muskelgruppeUebungen %}
                                    <div class="col-md-6 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input uebung-checkbox" type="checkbox" name="selected_uebungen[]" value="{{ uebung.uebung_id }}" id="uebung_{{ uebung.uebung_id }}">
                                            <label class="form-check-label" for="uebung_{{ uebung.uebung_id }}">
                                                {{ uebung.name }} ({{ uebung.schwierigkeitsgrad }})
                                                {% if uebung.koerperbereich %}
                                                <span class="badge bg-info">{{ uebung.koerperbereich }}</span>
                                                {% endif %}
                                                {% if uebung.uebungstyp %}
                                                <span class="badge bg-secondary">{{ uebung.uebungstyp }}</span>
                                                {% endif %}
                                            </label>
                                        </div>
                                        <div class="gewicht-input-container ml-4 mt-1" style="display: none;">
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" name="gewicht[{{ uebung.uebung_id }}]" placeholder="Gewicht in kg" step="0.5" min="0">
                                                <div class="input-group-append">
                                                    <span class="input-group-text">kg</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="mt-4">
                    <button type="submit" class="btn btn-primary" id="submitBtn">Trainingsplan erstellen</button>
                    <a href="{{ backUrl }}" class="btn btn-secondary">Zurück</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Funktion zum Ein-/Ausblenden der Gewichtsfelder
    function toggleGewichtFelder(show) {
        const gewichtFelder = document.querySelectorAll('.gewicht-input-container');
        gewichtFelder.forEach(feld => {
            feld.style.display = show ? 'block' : 'none';
        });
    }
    
    // Event-Listener für Übungs-Checkboxen
    document.addEventListener('DOMContentLoaded', function() {
        const checkboxes = document.querySelectorAll('.uebung-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const gewichtContainer = this.parentElement.nextElementSibling;
                if (this.checked && document.getElementById('manuelle_gewichte').checked) {
                    gewichtContainer.style.display = 'block';
                } else {
                    gewichtContainer.style.display = 'none';
                }
            });
        });
        
        // Event-Listener für Split-Typ-Änderungen
        document.getElementById('split_typ').addEventListener('change', function() {
            updateTrainingstageBasedOnSplit(this.value);
        });
        
        // Event-Listener für Trainingsfrequenz-Änderungen
        document.getElementById('trainingsfrequenz').addEventListener('change', function() {
            updateTrainingstageBasedOnFrequenz(parseInt(this.value));
        });
    });
    
    // Funktion zur Aktualisierung der Trainingstage basierend auf Split-Typ
    function updateTrainingstageBasedOnSplit(splitTyp) {
        // Alle Checkboxen zurücksetzen
        const alleTage = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
        alleTage.forEach(tag => {
            document.getElementById('tag_' + tag.toLowerCase()).checked = false;
        });
        
        // Standardtage basierend auf Split-Typ setzen
        if (splitTyp === 'Ganzkörper') {
            // Für Ganzkörper: Mo, Mi, Fr
            ['Montag', 'Mittwoch', 'Freitag'].forEach(tag => {
                document.getElementById('tag_' + tag.toLowerCase()).checked = true;
            });
        } else if (splitTyp === 'Zweier-Split') {
            // Für Zweier-Split: Mo, Di, Do, Fr
            ['Montag', 'Dienstag', 'Donnerstag', 'Freitag'].forEach(tag => {
                document.getElementById('tag_' + tag.toLowerCase()).checked = true;
            });
        } else if (splitTyp === 'Dreier-Split') {
            // Für Dreier-Split: Mo, Di, Mi, Do, Fr
            ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag'].forEach(tag => {
                document.getElementById('tag_' + tag.toLowerCase()).checked = true;
            });
        }
        
        // Anpassung an die aktuelle Trainingsfrequenz
        const frequenz = parseInt(document.getElementById('trainingsfrequenz').value);
        updateTrainingstageBasedOnFrequenz(frequenz);
    }
    
    // Funktion zur Aktualisierung der Trainingstage basierend auf Trainingsfrequenz
    function updateTrainingstageBasedOnFrequenz(frequenz) {
        const alleTage = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
        const ausgewaehlteCheckboxen = alleTage.filter(tag => 
            document.getElementById('tag_' + tag.toLowerCase()).checked
        );
        
        // Wenn mehr Tage ausgewählt sind als die Frequenz erlaubt, reduziere die Auswahl
        if (ausgewaehlteCheckboxen.length > frequenz) {
            // Deaktiviere überzählige Tage von hinten
            for (let i = ausgewaehlteCheckboxen.length - 1; i >= frequenz; i--) {
                document.getElementById('tag_' + ausgewaehlteCheckboxen[i].toLowerCase()).checked = false;
            }
        }
        // Wenn weniger Tage ausgewählt sind als die Frequenz erlaubt, erhöhe die Auswahl
        else if (ausgewaehlteCheckboxen.length < frequenz) {
            // Aktiviere zusätzliche Tage von vorne
            for (let i = 0; i < alleTage.length && ausgewaehlteCheckboxen.length < frequenz; i++) {
                const tag = alleTage[i];
                const checkbox = document.getElementById('tag_' + tag.toLowerCase());
                if (!checkbox.checked) {
                    checkbox.checked = true;
                    ausgewaehlteCheckboxen.push(tag);
                }
            }
        }
    }
</script>
{% endblock %}